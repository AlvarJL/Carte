<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aeroclub Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #map { height: 100vh; width: 100%; }

    .review-form {
      position: fixed;
      top: 20%;
      bottom: 20%;
      left: 20%;
      right: 20%;
      z-index: 1000;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      display: none;
      width: 60%;
      height: 60%;
      background-color: #042875;
      color: white;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
    }

    .close-btn:hover {
      color: #f44336;
    }

    .review-form input, .review-form textarea, .review-form button {
      display: block;
      margin: 15px auto;
      width: 90%;
      padding: 12px;
      border: 1px solid #B0C4DE;
      background-color: #f1f1f1;
      border-radius: 8px;
      color: #333;
      font-size: 16px;
      font-family: 'Arial', sans-serif;
    }

    .review-form input:focus, .review-form textarea:focus, .review-form button:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .review-form textarea {
      resize: vertical;
      min-height: 100px;
    }

    .review-form button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }

    .review-form button:hover {
      background-color: #45a049;
    }

    .review-form button:active {
      background-color: #388E3C;
    }

    .review-form input::placeholder,
    .review-form textarea::placeholder {
      color: #888;
      font-style: italic;
    }

    .popup-content {
      font-size: 14px;
      line-height: 1.6;
    }

    .review-section {
      border-top: 1px solid #ddd;
      margin-top: 10px;
      padding-top: 10px;
    }

    .review-box {
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 10px;
    }

    .review-box b {
      color: #042875;
    }

    .slider {
      width: 100%;
      margin: 10px 0;
    }

    /* Popup styling */
    .leaflet-popup-content {
      background-color: #042875; /* Match the review page background */
      color: white;
      padding: 15px;
      border-radius: 8px;
      width: 300px; /* Adjusted width */
      font-family: 'Arial', sans-serif;
    }

    .popup-header {
      font-size: 18px;
      font-weight: bold;
      color: #fff;
    }

    .popup-info {
      margin: 10px 0;
    }

    .popup-info span {
      font-weight: bold;
    }

    .popup-rating {
      margin-top: 10px;
      font-size: 16px;
    }

    .popup-divider {
      margin: 10px 0;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }

    .popup-reviews {
      font-size: 14px;
    }

    .popup-reviews .review-box {
      background-color: #f1f1f1;
      border-color: #ccc;
    }

    /* Updated text color in reviews */
    .popup-reviews .review-box p {
      color: black; /* Make review text black */
    }

    /* Added styling for date and rating */
    .popup-reviews .review-box .date {
      font-style: italic;
      color: #555; /* Lighter color for the date */
    }

    .popup-reviews .review-box .rating {
      font-weight: bold;
      color: #000; /* Ensure rating is black */
    }

    .icao-tooltip {
        background: none;
        border: none;
        color: black;
        font-weight: bold;
        font-size: 12px;
        text-align: center;
        box-shadow: none;
        pointer-events: none;
    }

  </style>
</head>
<body>
  <div id="map"></div>
  <div class="review-form" id="reviewForm">
    <span class="close-btn" id="closeReviewForm">X</span>
    <h3>Ajouter un avis</h3>
    <input type="text" id="reviewName" placeholder="Votre nom..." />
    <textarea id="reviewText" placeholder="Votre avis..."></textarea>
    <label for="reviewRating">Note (0 - 5)</label>
    <input type="range" id="reviewRating" class="slider" min="0" max="5" step="0.5" value="0">
    <span id="ratingValue">0</span>
    <button id="submitReviewBtn">Envoyer</button>
  </div>
  <button id="addAirportBtn" style="position: fixed; top: 100px; left: 12px; z-index: 9999; padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">Ajouter un Aérodrome</button>

<div class="review-form" id="addAirportForm" style="display: none;">
  <span class="close-btn" id="closeAirportForm">X</span>
  <h3>Ajouter un Aérodrome</h3>
  <input type="text" id="airportUsername" placeholder="Votre nom..." />
  <input type="text" id="airportName" placeholder="Nom de l'aérodrome..." />
  <input type="number" id="airportLat" placeholder="Latitude..." step="any" />
  <input type="number" id="airportLng" placeholder="Longitude..." step="any" />
  <input type="text" id="airportTax" placeholder="Taxe d'atterrissage..." />
  <button id="submitAirportBtn">Ajouter</button>
</div>


  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB4L7Ymgj6lFRkgL7WTlZJJxMA0k7NcCwc",
      authDomain: "carte-aerodromes-alcyons.firebaseapp.com",
      projectId: "carte-aerodromes-alcyons",
      storageBucket: "carte-aerodromes-alcyons.appspot.com",
      messagingSenderId: "110054223104",
      appId: "1:110054223104:web:23807e0c23f09e758d17e5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const map = L.map('map').setView([48.8, 2.2], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const reviewForm = document.getElementById("reviewForm");
    const reviewName = document.getElementById("reviewName");
    const reviewText = document.getElementById("reviewText");
    const reviewRating = document.getElementById("reviewRating");
    const ratingValue = document.getElementById("ratingValue");
    let currentAirportId = null;

    reviewRating.addEventListener('input', function() {
      ratingValue.textContent = reviewRating.value;
    });

    function getColor(rating) {
      if (rating >= 4.5) return '#4CAF50';
      if (rating >= 3.5) return '#8BC34A';
      if (rating >= 2.5) return '#FFEB3B';
      if (rating >= 1.5) return '#FF9800';
      return '#F44336';
    }

    function createMarker(airportId, data) {
  const coords = [data.location.latitude, data.location.longitude];
  const marker = L.circleMarker(coords, {
    radius: 10,
    fillColor: getColor(data.rating || 0),
    color: 'white',
    weight: 1,
    fillOpacity: 0.8
  }).addTo(map);

  // Add ICAO label as a tooltip
  const tooltip = L.tooltip({
    permanent: true,
    direction: 'bottom',
    offset: [0, 10], // Shift down slightly
    className: 'name-tooltip'
  })
  .setContent(data.name || '')
  .setLatLng(coords)
  .addTo(map);

  // Show tooltip only when zoomed in
  function toggleTooltip() {
    if (map.getZoom() >= 10) {
      tooltip.getElement().style.display = 'block';
    } else {
      tooltip.getElement().style.display = 'none';
    }
  }

  map.on('zoomend', toggleTooltip);
  toggleTooltip(); // Initial check

  marker.on('click', async () => {
    const reviewSnap = await db.collection("airports").doc(airportId).collection("reviews").orderBy("createdAt", "desc").get();
    let reviewsHtml = "<b>Avis:</b><br />";
    let ratingSum = 0;

    reviewSnap.forEach(doc => {
      const r = doc.data();
      ratingSum += r.reviewrating;
      const dateObj = r.createdAt?.toDate();
      const date = dateObj ? `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}` : "Unknown date";
      reviewsHtml += `
        <div class="review-box">
          <b>${r.username}</b> <span class="date">(${date}):</span>
          <p>${r.reviewtext}</p>
          <span class="rating">Note: ${r.reviewrating} ⭐</span>
        </div>
        <br />
      `;
    });

    const avgRating = reviewSnap.size > 0 ? (ratingSum / reviewSnap.size).toFixed(1) : "No ratings";
    await db.collection("airports").doc(airportId).update({ rating: parseFloat(avgRating) });

    marker.bindPopup(`
      <div class="popup-header">${data.name}</div>
      <div class="popup-info">
        <span>Taxe:</span> ${data.tax}<br>
      </div>
      <div class="popup-rating">Note: ${avgRating} ⭐</div>
      <div class="popup-divider"></div>
      <div class="popup-reviews">${reviewsHtml}</div>
      <button onclick="showReviewForm('${airportId}')">Ajouter un avis</button>
    `).openPopup();
  });
}


    window.showReviewForm = function(id) {
      reviewForm.style.display = 'block';
      currentAirportId = id;
    }

    document.getElementById("submitReviewBtn").addEventListener("click", async () => {
      const name = reviewName.value.trim();
      const text = reviewText.value.trim();
      const rating = parseFloat(reviewRating.value);
      if (!name || !text || isNaN(rating)) {
        alert("Please fill in all fields.");
        return;
      }

      await db.collection("airports").doc(currentAirportId).collection("reviews").add({
        username: name,
        reviewtext: text,
        reviewrating: rating,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      reviewForm.style.display = 'none';
      reviewName.value = "";
      reviewText.value = "";
      reviewRating.value = 0;
      ratingValue.textContent = 0;
      alert("Envoyé! Mettez à jour la page pour voir les modifications.");
    });

    document.getElementById("closeReviewForm").addEventListener("click", function() {
      reviewForm.style.display = 'none';
    });

    db.collection("airports").get().then(snapshot => {
      snapshot.forEach(doc => {
        createMarker(doc.id, doc.data());
      });
    });
  </script>
  <script>
    const addAirportBtn = document.getElementById("addAirportBtn");
    const addAirportForm = document.getElementById("addAirportForm");
    const closeAirportForm = document.getElementById("closeAirportForm");
  
    addAirportBtn.addEventListener("click", () => {
      addAirportForm.style.display = "block";
    });
  
    closeAirportForm.addEventListener("click", () => {
      addAirportForm.style.display = "none";
    });
  
    document.getElementById("submitAirportBtn").addEventListener("click", async () => {
      const username = document.getElementById("airportUsername").value.trim();
      const name = document.getElementById("airportName").value.trim();
      const lat = parseFloat(document.getElementById("airportLat").value);
      const lng = parseFloat(document.getElementById("airportLng").value);
      const tax = document.getElementById("airportTax").value.trim();
  
      if (!username || !name || isNaN(lat) || isNaN(lng) || !tax) {
        alert("Merci de remplir tous les champs.");
        return;
      }
  
      try {
        const docRef = await db.collection("airports").add({
          name: name,
          location: new firebase.firestore.GeoPoint(lat, lng),
          tax: tax,
          rating: 0
        });
  
        createMarker(docRef.id, {
          name: name,
          location: { latitude: lat, longitude: lng },
          tax: tax,
          rating: 0
        });
  
        alert("Aérodrome ajouté !");
        addAirportForm.style.display = "none";
      } catch (error) {
        console.error("Erreur:", error);
        alert("Échec de l'ajout.");
      }
    });
  </script>
  
</body>
</html>
